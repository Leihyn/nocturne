/**
 * Compute Poseidon zero hashes for the Merkle tree
 * These values will be embedded as constants in the Rust program
 */

import { buildPoseidon } from 'circomlibjs';

const MERKLE_DEPTH = 8;

async function main() {
  console.log('Computing Poseidon zero hashes for MERKLE_DEPTH =', MERKLE_DEPTH);
  console.log('');

  const poseidon = await buildPoseidon();

  // zeros[0] = 0 (empty leaf)
  let current = BigInt(0);
  const zeros = [current];

  console.log('// Pre-computed Poseidon zero hashes for MERKLE_DEPTH =', MERKLE_DEPTH);
  console.log('// zeros[i] = poseidon(zeros[i-1], zeros[i-1])');
  console.log('// Generated by scripts/compute-zero-hashes.mjs');
  console.log('pub const POSEIDON_ZERO_HASHES: [[u8; 32]; ' + (MERKLE_DEPTH + 1) + '] = [');

  // Print zeros[0]
  const zeroBytes = bigintToBytes32(current);
  console.log('    // Level 0: Zero value (empty leaf)');
  console.log('    ' + formatRustBytes(zeroBytes) + ',');

  // Compute and print zeros[1..MERKLE_DEPTH]
  for (let i = 1; i <= MERKLE_DEPTH; i++) {
    // poseidon([current, current])
    const hash = poseidon([current, current]);
    current = poseidon.F.toObject(hash);
    zeros.push(current);

    const hashBytes = bigintToBytes32(current);
    console.log('    // Level ' + i + ': poseidon(zeros[' + (i-1) + '], zeros[' + (i-1) + '])');
    console.log('    ' + formatRustBytes(hashBytes) + ',');
  }

  console.log('];');
  console.log('');
  console.log('// Root hash for empty tree (zeros[MERKLE_DEPTH])');
  console.log('pub const EMPTY_TREE_ROOT: [u8; 32] = ' + formatRustBytes(bigintToBytes32(zeros[MERKLE_DEPTH])) + ';');
}

function bigintToBytes32(n) {
  const hex = n.toString(16).padStart(64, '0');
  const bytes = [];
  for (let i = 0; i < 64; i += 2) {
    bytes.push(parseInt(hex.substr(i, 2), 16));
  }
  return bytes;
}

function formatRustBytes(bytes) {
  const hexBytes = bytes.map(b => '0x' + b.toString(16).padStart(2, '0'));
  // Format as [0x.., 0x.., ...] with line breaks every 8 bytes
  let result = '[';
  for (let i = 0; i < hexBytes.length; i++) {
    if (i > 0) result += ', ';
    result += hexBytes[i];
  }
  result += ']';
  return result;
}

main().catch(console.error);
